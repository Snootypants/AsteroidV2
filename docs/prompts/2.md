# Claude Code — OPUS PLAN MODE

Problem
- After the last commit the game renders at the wrong scale, the starfield is missing, and wave-1 asteroids do not appear.
- Root cause is a broken world→screen contract introduced by the new `utils/units.ts` plus missing initialization/wiring for Starfield and Spawning.

Objective
- Restore the original world scale, re-enable starfield rendering, and ensure wave-1 asteroid spawns. One diff, then commit and push.

Execution (Sonnet)
- Output ONE unified diff under `/diffs/` only. Then commit and push.

Scope
- UPDATE: /AsteroidsV2/reactShell/src/game/utils/units.ts
- UPDATE: /AsteroidsV2/reactShell/src/game/GameCanvas.tsx
- UPDATE: /AsteroidsV2/reactShell/src/game/systems/Starfield.ts (only if needed)
- UPDATE: /AsteroidsV2/reactShell/src/game/systems/Spawning.ts
- UPDATE: /AsteroidsV2/reactShell/src/game/entities/Bullet.ts (radius only if oversized)
- UPDATE: /AsteroidsV2/reactShell/src/game/entities/Ship.ts (sprite scale derived from radius)

Exact changes to implement

1) Fix world units and bounds (single source of truth)
- In `utils/units.ts`:
  - Export a mutable `WORLD_BOUNDS` and a `configureWorld(width: number, height: number)` that sets:
    ```ts
    // half-extents derived from render size (keep prior design: ~750x498 world)
    const halfW = 375, halfH = 249;
    WORLD_BOUNDS = { minX: -halfW, maxX: halfW, minY: -halfH, maxY: halfH } as const;
    ```
    Do not compute from devicePixelRatio. Keep 1 world unit == 1 pixel for now.
  - Keep `pxToWorld(n)` returning `n`.
  - Export `getWorldSize()` returning `{ width: 750, height: 498 }` so camera/spawn systems don’t duplicate constants.

2) Camera and resize wiring; re-enable starfield
- In `GameCanvas.tsx`:
  - On mount and on window resize, call `configureWorld(canvas.clientWidth, canvas.clientHeight)` and then set the orthographic camera:
    ```ts
    camera.left = WORLD_BOUNDS.minX; camera.right = WORLD_BOUNDS.maxX;
    camera.top = WORLD_BOUNDS.maxY; camera.bottom = WORLD_BOUNDS.minY;
    camera.updateProjectionMatrix();
    ```
  - Ensure Starfield system is created before other entities and added to the scene. If it was removed from the update loop, re-insert its `update(dt)` call each frame.

3) Restore starfield defaults if the module exists but renders nothing
- In `systems/Starfield.ts` (only if necessary):
  - Use particles sized in world units (1.0–1.5) and place them uniformly within `WORLD_BOUNDS` with wrap logic identical to bullets.
  - Ensure the material is not depth-tested so stars render behind sprites:
    ```ts
    material.depthWrite = false; material.depthTest = false; material.transparent = true;
    ```

4) Fix asteroid spawning on wave 1
- In `systems/Spawning.ts`:
  - Ensure wave 1 spawns asteroids. If there is a `wave >= 1` guard that accidentally became `> 1`, change it to `>= 1`.
  - Use `getWorldSize()` or `WORLD_BOUNDS` to spawn just outside the world with a 20u buffer, then wrap.
  - Keep original counts/speeds; do not change gameplay balance.

5) Normalize visual scale from entity radii
- In `entities/Ship.ts`:
  - Derive sprite scale from `radius` so texture size doesn’t blow up visuals. Set:
    ```ts
    // assume sprite nominal width == 2*radius in world units
    sprite.scale.set(2*radius, 2*radius, 1);
    ```
- In `entities/Bullet.ts`:
  - If bullets render oversized, clamp `radius` to `0.28` and ensure mesh/sprite uses `2*radius` for scale.

Acceptance
- Starfield visible again behind everything.
- Ship and bullets appear at reasonable size (radius-driven).
- Asteroids spawn on wave 1 and wrap correctly.
- Canvas resize preserves scale and bounds.

Deliverable
- Print ONE timestamped unified diff under `/diffs/` with all edits above. No truncation.
- Then commit and push with message:
  `fix(world): restore world scale, re-enable starfield, and ensure wave-1 asteroid spawns`